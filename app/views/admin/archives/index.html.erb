<% content_for :main_content do %>

<style>
  .col-md-2 {
    width: 16%;
  }
  .select {
    /*width: 228px;*/
    /*height: 43px;*/
    /*padding-left: 25px;*/
  }
  .left-2 {
    width: 18%;
  }
</style>

<div class="main-content ">
  <div class="breadcrumbs" id="breadcrumbs">
    <ul class="breadcrumb">
      <%= render 'partials/home' %>
      <li><%= link_to '档案管理', admin_archives_path %></li>
      <!-- <li><%= link_to '档案管理', admin_archives_path %></li> -->
    </ul>
    <%#= render '/layouts/qrcode' %>
  </div>

  <div class="page-content">
    <div class="row">
    <%= form_for @search, url: admin_archives_path, html: { method: :get } do |f| %>
      <div class="col-md-12">
        <div class="col-md-2">
          <%= f.select :first_category_id_eq, ArchiveCategory.root.pluck(:name, :id), {include_blank: '请选择一级分类'}, class: 'col-xs-12 select' %>
        </div>
        <div class="col-md-2">
          <%= f.select :second_category_id_eq, @search.first_category_id_eq.present? ? ArchiveCategory.where(parent_id: @search.first_category_id_eq).pluck(:name, :id) : [], {include_blank: '请选择二级分类'}, class: 'col-xs-12 select' %>
        </div>
        <div class="col-md-2">
          <%= f.select :three_category_id_eq, @search.second_category_id_eq.present? ? ArchiveCategory.where(parent_id: @search.second_category_id_eq).pluck(:name, :id) : [], {include_blank: '请选择三级分类'}, class: 'col-xs-12 select' %>
        </div>

        <div class="col-md-2">
          <div class="input-group input-group-text ">
            <%=f.text_field :name_or_file_name_like, placeholder: '档案名称/文件名称',class: 'col-xs-12 cc'%>
          </div>
        </div>

        <div class="col-md-4">
          <%= f.submit '查询', class: 'btn btn-sm btn-filter btn-primary' %>

          <a class="btn btn-primary btn-sm btn-filter pull-right" data-target="addUser" data-toggle="modals" data-title="新增档案  " data-height="1000" data-iframe="/admin/archives/new">新增</a>
        </div>
      </div>
    <% end %>
    </div>

    <div class="col-md-12 margin-top-10">
      <table id="vweddingTable"
        class="table table-striped table-bordered table-hover dataTable ">
        <thead>
          <tr>
            <th>所属分类</th>
            <th>档案名称</th>
            <th>文件名称</th>
            <th>上传时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <% @archives.each do |archive| %>
            <tr>
              <td><%= archive.category_name %></td>
              <td><%= archive.name %></td>
              <td><%= archive.file_name.try(:file).try(:filename) %></td>
              <td><%= archive.created_at %></td>
              <td>
                <%= link_to "下载", archive.file_name.url if archive.file_name? %>
                <a href="javascript:;" class="fgreen" data-target="editUser" data-toggle="modals" data-title="编辑档案" data-height="1000" data-iframe="/admin/archives/<%= archive.id %>">编辑</a>
                <%= link_to '删除', admin_archive_path(archive), method: :delete, data: {confirm: '确定删除？'} %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <div class="pagination page width-auto"><%= page_entries_info @archives %></div>
      <%= paginate @archives %>
    </div>
  </div>
</div>
<% end %>

<script type="text/javascript">
  $("#search_first_category_id_eq").on('change', function(e){
    var first_category_id = $(this).val();

    refreshSecondOption(first_category_id);
  });

  $("#search_second_category_id_eq").on('change', function(e){
    var second_category_id = $(this).val();

    refreshThreeOption(second_category_id);
  });

  function refreshSecondOption(first_category_id) {
    $.ajax({
      url: "/admin/archives/categories",
      data: { "category_id": first_category_id },
      dataType: 'json',
      success: function(result){
        var options = $("#search_second_category_id_eq");
        options.empty(); // remove old options
        options.append($("<option></option>").attr("value", '').text('请选择二级分类'));

        var three_options = $("#search_three_category_id_eq");
        three_options.empty();
        three_options.append($("<option></option>").attr("value", '').text('请选择三级分类'));

        $.each(result, function(index, option) {
          options.append($("<option></option>")
            .attr("value", option.id).text(option.name));
        });
      }
    });
  }

  function refreshThreeOption(second_category_id) {
    $.ajax({
      url: "/admin/archives/categories",
      data: { "category_id": second_category_id },
      dataType: 'json',
      success: function(result){
        var options = $("#search_three_category_id_eq");
        options.empty(); // remove old options

        options.append($("<option></option>").attr("value", '').text('请选择三级分类'));

        $.each(result, function(index, option) {
          options.append($("<option></option>")
            .attr("value", option.id).text(option.name));
        });
      }
    });
  }
</script>
